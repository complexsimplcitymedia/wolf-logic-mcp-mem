{% extends 'memories/base.html' %}

{% block title %}All Memories{% endblock title %}

{% block extrastyle %}
<style>
  .memory-content {
    max-width: 500px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .filter-badge {
    cursor: pointer;
  }
</style>
{% endblock extrastyle %}

{% block content %}
<!-- [ breadcrumb ] start -->
<div class="page-header">
  <div class="page-block">
    <div class="row align-items-center">
      <div class="col-md-12">
        <div class="page-header-title">
          <h5 class="m-b-10">Memories</h5>
        </div>
        <ul class="breadcrumb">
          <li class="breadcrumb-item"><a href="{{ url_for('memories_blueprint.dashboard') }}">Home</a></li>
          <li class="breadcrumb-item" aria-current="page">Memories</li>
        </ul>
      </div>
    </div>
  </div>
</div>
<!-- [ breadcrumb ] end -->

<!-- Filters and Search -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <form method="GET" action="{{ url_for('memories_blueprint.memories') }}" id="filterForm">
          <div class="row g-3 align-items-end">
            <!-- Search -->
            <div class="col-md-4">
              <label class="form-label">Search</label>
              <input type="text" class="form-control" name="search"
                     placeholder="Search memories..."
                     value="{{ filters.search }}">
            </div>

            <!-- Apps Filter -->
            <div class="col-md-3">
              <label class="form-label">Filter by App</label>
              <select class="form-select" name="apps" multiple id="appsFilter">
                {% for app in apps %}
                  <option value="{{ app.name }}"
                          {% if app.name in filters.apps %}selected{% endif %}>
                    {{ app.name }} ({{ app.total_memories }})
                  </option>
                {% endfor %}
              </select>
            </div>

            <!-- Categories Filter -->
            <div class="col-md-3">
              <label class="form-label">Filter by Category</label>
              <select class="form-select" name="categories" multiple id="categoriesFilter">
                {% for category in categories %}
                  <option value="{{ category }}"
                          {% if category in filters.categories %}selected{% endif %}>
                    {{ category }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <!-- Show Archived -->
            <div class="col-md-2">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" name="show_archived" value="true"
                       id="showArchived" {% if filters.show_archived %}checked{% endif %}>
                <label class="form-check-label" for="showArchived">
                  Show Archived
                </label>
              </div>
              <button type="submit" class="btn btn-primary w-100 mt-2">
                <i class="ti ti-search me-1"></i> Filter
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Bulk Actions -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div>
          <h5 class="mb-0">All Memories <span class="badge bg-primary ms-2">{{ total }}</span></h5>
        </div>
        <div class="btn-group">
          <button type="button" class="btn btn-sm btn-success" onclick="showCreateModal()">
            <i class="ti ti-plus me-1"></i> New Memory
          </button>
          <button type="button" class="btn btn-sm btn-warning" onclick="bulkAction('pause')" id="pauseBtn" disabled>
            <i class="ti ti-player-pause me-1"></i> Pause Selected
          </button>
          <button type="button" class="btn btn-sm btn-secondary" onclick="bulkAction('archive')" id="archiveBtn" disabled>
            <i class="ti ti-archive me-1"></i> Archive Selected
          </button>
          <button type="button" class="btn btn-sm btn-danger" onclick="bulkAction('delete')" id="deleteBtn" disabled>
            <i class="ti ti-trash me-1"></i> Delete Selected
          </button>
        </div>
      </div>
      <div class="card-body">
        {% if memories %}
          <form id="bulkActionForm" method="POST">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th style="width: 40px;">
                      <input type="checkbox" class="form-check-input" id="selectAll">
                    </th>
                    <th>Content</th>
                    <th>Categories</th>
                    <th>App</th>
                    <th>Created</th>
                    <th>State</th>
                    <th class="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for memory in memories %}
                  <tr>
                    <td>
                      <input type="checkbox" class="form-check-input memory-checkbox"
                             name="memory_ids" value="{{ memory.id }}">
                    </td>
                    <td>
                      <div class="memory-content" title="{{ memory.content }}">
                        {{ memory.content }}
                      </div>
                    </td>
                    <td>
                      {% if memory.categories %}
                        {% for category in memory.categories[:2] %}
                          <span class="badge bg-light-primary me-1">{{ category.name }}</span>
                        {% endfor %}
                        {% if memory.categories|length > 2 %}
                          <span class="badge bg-light-secondary">+{{ memory.categories|length - 2 }}</span>
                        {% endif %}
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if memory.app %}
                        <span class="badge bg-light-info">{{ memory.app.name }}</span>
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </td>
                    <td>
                      <small class="text-muted">{{ memory.created_at[:10] }}</small>
                    </td>
                    <td>
                      {% if memory.state == 'active' %}
                        <span class="badge bg-light-success">Active</span>
                      {% elif memory.state == 'paused' %}
                        <span class="badge bg-light-warning">Paused</span>
                      {% elif memory.state == 'archived' %}
                        <span class="badge bg-light-secondary">Archived</span>
                      {% else %}
                        <span class="badge bg-light-dark">{{ memory.state }}</span>
                      {% endif %}
                    </td>
                    <td class="text-end">
                      <a href="{{ url_for('memories_blueprint.memory_detail', memory_id=memory.id) }}"
                         class="btn btn-sm btn-link-primary" title="View">
                        <i class="ti ti-eye"></i>
                      </a>
                      <a href="{{ url_for('memories_blueprint.edit_memory', memory_id=memory.id) }}"
                         class="btn btn-sm btn-link-secondary" title="Edit">
                        <i class="ti ti-edit"></i>
                      </a>
                      <button type="button" class="btn btn-sm btn-link-danger"
                              onclick="deleteMemory('{{ memory.id }}')" title="Delete">
                        <i class="ti ti-trash"></i>
                      </button>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </form>

          <!-- Pagination -->
          {% if total_pages > 1 %}
          <nav aria-label="Page navigation" class="mt-3">
            <ul class="pagination justify-content-center">
              {% if page > 1 %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page - 1 }}&page_size={{ page_size }}&search={{ filters.search }}&show_archived={{ filters.show_archived }}">
                  Previous
                </a>
              </li>
              {% endif %}

              {% for p in range(1, total_pages + 1) %}
                {% if p == page %}
                <li class="page-item active"><span class="page-link">{{ p }}</span></li>
                {% elif p <= 3 or p > total_pages - 3 or (p >= page - 1 and p <= page + 1) %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ p }}&page_size={{ page_size }}&search={{ filters.search }}&show_archived={{ filters.show_archived }}">
                    {{ p }}
                  </a>
                </li>
                {% elif p == 4 or p == total_pages - 3 %}
                <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
              {% endfor %}

              {% if page < total_pages %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page + 1 }}&page_size={{ page_size }}&search={{ filters.search }}&show_archived={{ filters.show_archived }}">
                  Next
                </a>
              </li>
              {% endif %}
            </ul>
          </nav>
          {% endif %}

        {% else %}
          <div class="text-center py-5">
            <i class="ti ti-database-off" style="font-size: 64px; opacity: 0.3;"></i>
            <h5 class="mt-3 text-muted">No memories found</h5>
            <p class="text-muted">Try adjusting your filters or create a new memory</p>
            <a href="{{ url_for('memories_blueprint.create_memory') }}" class="btn btn-primary mt-2">
              <i class="ti ti-plus me-2"></i> Create Memory
            </a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% endblock content %}

{% block extra_js %}
<script>
  // Select All checkbox
  document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.memory-checkbox');
    checkboxes.forEach(cb => cb.checked = this.checked);
    updateBulkActionButtons();
  });

  // Individual checkbox change
  document.querySelectorAll('.memory-checkbox').forEach(cb => {
    cb.addEventListener('change', updateBulkActionButtons);
  });

  function updateBulkActionButtons() {
    const checked = document.querySelectorAll('.memory-checkbox:checked').length;
    document.getElementById('pauseBtn').disabled = checked === 0;
    document.getElementById('archiveBtn').disabled = checked === 0;
    document.getElementById('deleteBtn').disabled = checked === 0;
  }

  function bulkAction(action) {
    const form = document.getElementById('bulkActionForm');
    const checked = document.querySelectorAll('.memory-checkbox:checked').length;

    if (checked === 0) {
      alert('Please select at least one memory');
      return;
    }

    let confirmMsg = '';
    let url = '';

    if (action === 'delete') {
      confirmMsg = `Are you sure you want to delete ${checked} memories? This action cannot be undone.`;
      url = '{{ url_for("memories_blueprint.bulk_delete") }}';
    } else if (action === 'pause') {
      confirmMsg = `Pause ${checked} selected memories?`;
      url = '{{ url_for("memories_blueprint.bulk_pause") }}';
    } else if (action === 'archive') {
      confirmMsg = `Archive ${checked} selected memories?`;
      url = '{{ url_for("memories_blueprint.bulk_archive") }}';
    }

    if (confirm(confirmMsg)) {
      form.action = url;
      form.submit();
    }
  }

  function deleteMemory(memoryId) {
    if (confirm('Are you sure you want to delete this memory?')) {
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = `/memories/${memoryId}/delete`;
      document.body.appendChild(form);
      form.submit();
    }
  }

  function showCreateModal() {
    window.location.href = '{{ url_for("memories_blueprint.create_memory") }}';
  }
</script>
{% endblock extra_js %}
