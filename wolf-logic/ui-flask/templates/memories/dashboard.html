{% extends 'memories/base.html' %}

{% block title %}Dashboard{% endblock title %}

{% block content %}
<!-- [ breadcrumb ] start -->
<div class="page-header">
  <div class="page-block">
    <div class="row align-items-center">
      <div class="col-md-12">
        <div class="page-header-title">
          <h5 class="m-b-10">Dashboard</h5>
        </div>
        <ul class="breadcrumb">
          <li class="breadcrumb-item"><a href="{{ url_for('memories_blueprint.dashboard') }}">Home</a></li>
          <li class="breadcrumb-item" aria-current="page">Dashboard</li>
        </ul>
      </div>
    </div>
  </div>
</div>
<!-- [ breadcrumb ] end -->

<!-- [ Main Content ] start -->
<div class="row">
  <!-- Statistics Cards -->
  <div class="col-md-6 col-xl-4">
    <div class="card bg-primary-dark dashnum-card text-white overflow-hidden">
      <span class="round small"></span>
      <span class="round big"></span>
      <div class="card-body">
        <div class="row">
          <div class="col">
            <div class="avtar avtar-lg">
              <i class="ti ti-database text-white f-30"></i>
            </div>
          </div>
          <div class="col-auto">
            <div class="dashnum">
              <h2 class="text-white mb-1" id="total-memories">{{ stats.get('total_memories', 0) }}</h2>
              <span class="text-white text-opacity-75">Total Memories</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-6 col-xl-4">
    <div class="card bg-success-dark dashnum-card text-white overflow-hidden">
      <span class="round small"></span>
      <span class="round big"></span>
      <div class="card-body">
        <div class="row">
          <div class="col">
            <div class="avtar avtar-lg">
              <i class="ti ti-apps text-white f-30"></i>
            </div>
          </div>
          <div class="col-auto">
            <div class="dashnum">
              <h2 class="text-white mb-1" id="total-apps">{{ stats.get('total_apps', 0) }}</h2>
              <span class="text-white text-opacity-75">Total Apps</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-6 col-xl-4">
    <div class="card bg-info-dark dashnum-card text-white overflow-hidden">
      <span class="round small"></span>
      <span class="round big"></span>
      <div class="card-body">
        <div class="row">
          <div class="col">
            <div class="avtar avtar-lg">
              <i class="ti ti-clock text-white f-30"></i>
            </div>
          </div>
          <div class="col-auto">
            <div class="dashnum">
              <h2 class="text-white mb-1">{{ memories|length }}</h2>
              <span class="text-white text-opacity-75">Recent Memories</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quick Actions -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5>Quick Actions</h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-3">
            <a href="{{ url_for('memories_blueprint.create_memory') }}" class="btn btn-primary w-100">
              <i class="ti ti-plus me-2"></i> Create Memory
            </a>
          </div>
          <div class="col-md-3">
            <a href="{{ url_for('memories_blueprint.memories') }}" class="btn btn-outline-primary w-100">
              <i class="ti ti-list me-2"></i> View All Memories
            </a>
          </div>
          <div class="col-md-3">
            <a href="{{ url_for('memories_blueprint.apps') }}" class="btn btn-outline-secondary w-100">
              <i class="ti ti-apps me-2"></i> Manage Apps
            </a>
          </div>
          <div class="col-md-3">
            <a href="{{ url_for('memories_blueprint.export_memories') }}" class="btn btn-outline-info w-100">
              <i class="ti ti-download me-2"></i> Export Backup
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Recent Memories -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Recent Memories</h5>
        <a href="{{ url_for('memories_blueprint.memories') }}" class="btn btn-sm btn-link">View All <i class="ti ti-arrow-right"></i></a>
      </div>
      <div class="card-body">
        {% if memories %}
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Content</th>
                  <th>Categories</th>
                  <th>App</th>
                  <th>Created</th>
                  <th>State</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for memory in memories %}
                <tr>
                  <td>
                    <div class="text-truncate" style="max-width: 400px;">
                      {{ memory.content }}
                    </div>
                  </td>
                  <td>
                    {% if memory.categories %}
                      {% for category in memory.categories[:3] %}
                        <span class="badge bg-light-primary me-1">{{ category.name }}</span>
                      {% endfor %}
                      {% if memory.categories|length > 3 %}
                        <span class="badge bg-light-secondary">+{{ memory.categories|length - 3 }}</span>
                      {% endif %}
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if memory.app %}
                      <span class="badge bg-light-info">{{ memory.app.name }}</span>
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td>
                    <small class="text-muted">{{ memory.created_at[:10] }}</small>
                  </td>
                  <td>
                    {% if memory.state == 'active' %}
                      <span class="badge bg-light-success">Active</span>
                    {% elif memory.state == 'paused' %}
                      <span class="badge bg-light-warning">Paused</span>
                    {% elif memory.state == 'archived' %}
                      <span class="badge bg-light-secondary">Archived</span>
                    {% else %}
                      <span class="badge bg-light-dark">{{ memory.state }}</span>
                    {% endif %}
                  </td>
                  <td class="text-end">
                    <a href="{{ url_for('memories_blueprint.memory_detail', memory_id=memory.id) }}"
                       class="btn btn-sm btn-link-primary" title="View Details">
                      <i class="ti ti-eye"></i>
                    </a>
                    <a href="{{ url_for('memories_blueprint.edit_memory', memory_id=memory.id) }}"
                       class="btn btn-sm btn-link-secondary" title="Edit">
                      <i class="ti ti-edit"></i>
                    </a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-center py-5">
            <i class="ti ti-database-off" style="font-size: 64px; opacity: 0.3;"></i>
            <h5 class="mt-3 text-muted">No memories yet</h5>
            <p class="text-muted">Create your first memory to get started</p>
            <a href="{{ url_for('memories_blueprint.create_memory') }}" class="btn btn-primary mt-2">
              <i class="ti ti-plus me-2"></i> Create Memory
            </a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Active Apps Summary -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Active Applications</h5>
        <a href="{{ url_for('memories_blueprint.apps') }}" class="btn btn-sm btn-link">Manage Apps <i class="ti ti-arrow-right"></i></a>
      </div>
      <div class="card-body">
        {% if apps %}
          <div class="row g-3">
            {% for app in apps[:6] %}
              {% if app.is_active %}
              <div class="col-md-4">
                <div class="card mb-0 border">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <h6 class="mb-1">{{ app.name }}</h6>
                        <small class="text-muted">{{ app.total_memories }} memories</small>
                      </div>
                      <div class="avtar avtar-s bg-light-success">
                        <i class="ti ti-check"></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              {% endif %}
            {% endfor %}
          </div>
        {% else %}
          <div class="text-center py-3">
            <p class="text-muted mb-0">No active applications</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% endblock content %}

{% block extra_js %}
<script>
  // Auto-refresh stats every 30 seconds
  setInterval(function() {
    fetch('{{ url_for("memories_blueprint.api_stats") }}')
      .then(response => response.json())
      .then(data => {
        document.getElementById('total-memories').textContent = data.total_memories || 0;
        document.getElementById('total-apps').textContent = data.total_apps || 0;
      })
      .catch(error => console.error('Error refreshing stats:', error));
  }, 30000);
</script>
{% endblock extra_js %}
